<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>মক্তব রিপোর্ট বোর্ড</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--muted:#666}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Bengali",Arial; background:var(--bg); margin:0; padding:20px; color:#111}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    button.badge{background:linear-gradient(180deg,#ffffff,#f0f0f0);border:1px solid #ddd;padding:10px 14px;border-radius:8px;cursor:pointer;min-width:140px}
    button.badge strong{display:block;font-size:18px}
    .search-row{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .search-row input, .search-row select{padding:8px;border-radius:8px;border:1px solid #ccc;min-width:160px}
    table{width:100%;border-collapse:collapse;background:var(--card);box-shadow:0 4px 18px rgba(10,10,10,0.04);border-radius:8px;overflow:hidden}
    thead th{background:#fafafa;padding:10px;text-align:left;border-bottom:1px solid #eee;font-weight:600}
    tbody td{padding:10px;border-bottom:1px solid #f1f1f1}
    tbody tr:hover{background:#fbfdff}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .summary-area{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .pill{background:#fff;border:1px solid #e6e6e6;padding:8px 12px;border-radius:999px}
    @media (max-width:800px){.search-row input{min-width:120px}thead{display:none}tbody td{display:block;padding:8px}tbody td:before{content:attr(data-label);font-weight:600;display:inline-block;width:120px}}  
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1> বাংলা সেবামক্তব এর সকল রেপোর্ট </h1>
      <div class="controls">
        <button id="btnTotal" class="badge">টোটাল স্টুডেন্ট<br><strong id="totalCount">—</strong></button>
        <button id="btnByJela" class="badge">জেলা অনুযায়ী<br><strong id="jelaSummary">—</strong></button>
        <button id="btnToday" class="badge">আজকের ভর্তি<br><strong id="todayCount">—</strong></button>
        <button id="btnTaka" class="badge">মোট টাকা<br><strong id="takaTotal">—</strong></button>
        <button id="btnJoma" class="badge">মোট জমা হয়েছে<br><strong id="jomaTotal">—</strong></button>
      </div>
    </header>

    <div class="search-row" style="margin-top:12px">
      <input id="qDate" type="date" placeholder="তারিখ (YYYY-MM-DD)" />
      <input id="qName" type="search" placeholder="নাম দিয়ে সার্চ" />
      <input id="qFather" type="search" placeholder="পিতার নাম" />
      <input id="qMother" type="search" placeholder="মাতার নাম" />
      <input id="qJela" type="search" placeholder="জেলা" />
      <input id="qOpojela" type="search" placeholder="উপজেলা" />
      <input id="qID" type="search" placeholder="Student ID" />
      <input id="qGlobal" type="search" placeholder="জেনারেল সার্চ " style="min-width:220px" />
      <button id="btnClear" class="pill">Clear</button>
    </div>

    <div class="summary-area" id="summaryArea"></div>

    <div style="overflow:auto">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Name</th>
            <th>Father</th>
            <th>Mother</th>
            <th>Jela</th>
            <th>Opojela</th>
            <th>Phone</th>
            <th>StudentID</th>
            <th>Taka</th>
            <th>Joma</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  

    

  </div>

  <script>
    // ================== CONFIG ==================
    // আপনার Google Sheet ID এবং শিটের নাম এখানে বসান
    const SHEET_ID = '1uzehSN2lGI6gNlM8w3eHEEbyZ14UcoRCBuOldH0Rljc';
    const SHEET_NAME = 'Sheet1';
    // ============================================

    const apiUrl = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(SHEET_NAME)}`;

    // Utility: parse number safely
    function toNumber(v){
      if(v===undefined || v===null) return 0;
      v = String(v).replace(/[^0-9.\-]/g,'');
      const n = parseFloat(v);
      return isNaN(n)?0:n;
    }

    let rawData = [];
    const tbody = document.querySelector('#dataTable tbody');

    async function fetchData(){
      try{
        showLoading();
        const res = await fetch(apiUrl);
        if(!res.ok) throw new Error('OpenSheet response not OK')
        const data = await res.json();
        // Expecting objects with keys matching column headers
        rawData = data.map(row=>({
          timestamp: row.timestamp || row.Timestamp || '',
          name: row.name || row.Name || '',
          father: row.father || row.Father || '',
          mother: row.mother || row.Mother || '',
          jela: row.jela || row.Jela || '',
          opojela: row.opojela || row.Opojela || row.opojela || '',
          phone: row.phone || row.Phone || '',
          studentID: row.studentID || row.StudentID || row.studentId || '',
          taka: toNumber(row.taka || row.Taka || '0'),
          joma: toNumber(row.joma || row.Joma || '0')
        }));
        renderAll();
      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="10">ডেটা লোড করা যায়নি — নিশ্চিত করুন OpenSheet URL এবং Sheet ID সঠিক আছে।<br><small class="muted">${err.message}</small></td></tr>`
      }
    }

    function showLoading(){
      tbody.innerHTML = '<tr><td colspan="10">load data…</td></tr>';
    }

    // Filtering
    function getFilters(){
      return {
        date: document.getElementById('qDate').value,
        name: document.getElementById('qName').value.trim().toLowerCase(),
        father: document.getElementById('qFather').value.trim().toLowerCase(),
        mother: document.getElementById('qMother').value.trim().toLowerCase(),
        jela: document.getElementById('qJela').value.trim().toLowerCase(),
        opojela: document.getElementById('qOpojela').value.trim().toLowerCase(),
        id: document.getElementById('qID').value.trim().toLowerCase(),
        global: document.getElementById('qGlobal').value.trim().toLowerCase()
      }
    }

    function matchesFilter(row, f){
      if(f.date){
        // compare only date part (YYYY-MM-DD)
        const d = row.timestamp ? (new Date(row.timestamp)).toISOString().slice(0,10) : '';
        if(d !== f.date) return false;
      }
      if(f.name && !row.name.toLowerCase().includes(f.name)) return false;
      if(f.father && !row.father.toLowerCase().includes(f.father)) return false;
      if(f.mother && !row.mother.toLowerCase().includes(f.mother)) return false;
      if(f.jela && !row.jela.toLowerCase().includes(f.jela)) return false;
      if(f.opojela && !row.opojela.toLowerCase().includes(f.opojela)) return false;
      if(f.id && !row.studentID.toLowerCase().includes(f.id)) return false;
      if(f.global){
        const hay = `${row.name} ${row.phone} ${row.studentID} ${row.jela} ${row.opojela}`.toLowerCase();
        if(!hay.includes(f.global)) return false;
      }
      return true;
    }

    function renderTable(filtered){
      if(!filtered.length){
        tbody.innerHTML = '<tr><td colspan="10">No result।</td></tr>';
        return;
      }
      const rows = filtered.map(r=>{
        const ts = r.timestamp || '';
        const ph = r.phone || '';
        const phoneLink = ph ? `<a href="tel:${ph.replace(/[^0-9+]/g,'')}">${ph}</a>` : '';
        return `
        <tr>
          <td data-label="Timestamp">${escapeHtml(ts)}</td>
          <td data-label="Name">${escapeHtml(r.name)}</td>
          <td data-label="Father">${escapeHtml(r.father)}</td>
          <td data-label="Mother">${escapeHtml(r.mother)}</td>
          <td data-label="Jela">${escapeHtml(r.jela)}</td>
          <td data-label="Opojela">${escapeHtml(r.opojela)}</td>
          <td data-label="Phone">${phoneLink}</td>
          <td data-label="StudentID">${escapeHtml(r.studentID)}</td>
          <td data-label="Taka">${r.taka}</td>
          <td data-label="Joma">${r.joma}</td>
        </tr>`
      }).join('');
      tbody.innerHTML = rows;
    }

    function escapeHtml(s){
      return String(s || '').replace(/[&<>\"]/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]});
    }

    function computeSummaries(filtered){
      const totalStudents = rawData.length;
      const today = new Date();
      const todayISO = today.toISOString().slice(0,10);
      const todayCount = rawData.filter(r=>{
        const d = r.timestamp ? (new Date(r.timestamp)).toISOString().slice(0,10) : '';
        return d===todayISO;
      }).length;

      const takaTotal = rawData.reduce((s,r)=>s + (toNumber(r.taka)||0),0);
      const jomaTotal = rawData.reduce((s,r)=>s + (toNumber(r.joma)||0),0);

      // jela summary
      const jelaMap = {};
      rawData.forEach(r=>{
        const key = (r.jela||'distric')
        jelaMap[key] = (jelaMap[key]||0) + 1;
      });

      // render in UI
      document.getElementById('totalCount').textContent = totalStudents;
      document.getElementById('todayCount').textContent = todayCount;
      document.getElementById('takaTotal').textContent = takaTotal;
      document.getElementById('jomaTotal').textContent = jomaTotal;
      document.getElementById('jelaSummary').textContent = Object.keys(jelaMap).length + ' Distric';

      // build a small summary area
      const summaryArea = document.getElementById('summaryArea');
      const topJelas = Object.entries(jelaMap).sort((a,b)=>b[1]-a[1]).slice(0,6);
      summaryArea.innerHTML = topJelas.map(x=>`<div class="pill">${escapeHtml(x[0])}: ${x[1]}</div>`).join('');

      return {totalStudents,todayCount,takaTotal,jomaTotal,jelaMap};
    }

    function renderAll(){
      const f = getFilters();
      const filtered = rawData.filter(r=>matchesFilter(r,f));
      renderTable(filtered);
      computeSummaries(filtered);
    }

    // Events
    document.querySelectorAll('#qDate,#qName,#qFather,#qMother,#qJela,#qOpojela,#qID,#qGlobal').forEach(el=>{
      el.addEventListener('input', ()=> renderAll());
    });

    document.getElementById('btnClear').addEventListener('click', ()=>{
      ['qDate','qName','qFather','qMother','qJela','qOpojela','qID','qGlobal'].forEach(id=>document.getElementById(id).value='');
      renderAll();
    });

    document.getElementById('btnByJela').addEventListener('click', ()=>{
      const {jelaMap} = computeSummaries();
      // show modal-like alert with counts
      const items = Object.entries(jelaMap).sort((a,b)=>b[1]-a[1]).map(x=>`${x[0]} — ${x[1]}`).join('\n');
      alert('Distric in student:\n\n' + items);
    });

    document.getElementById('btnTotal').addEventListener('click', ()=>{
      const {totalStudents} = computeSummaries();
      alert('Total student: ' + totalStudents);
    });

    document.getElementById('btnToday').addEventListener('click', ()=>{
      const {todayCount} = computeSummaries();
      alert('Today add: ' + todayCount);
    });

    document.getElementById('btnTaka').addEventListener('click', ()=>{
      const {takaTotal} = computeSummaries();
      alert('Total TK: ' + takaTotal);
    });

    document.getElementById('btnJoma').addEventListener('click', ()=>{
      const {jomaTotal} = computeSummaries();
      alert('Total collect: ' + jomaTotal);
    });

    // initial fetch
    if(SHEET_ID === 'YOUR SHEET ID HEER'){
      tbody.innerHTML = `<tr><td colspan="10">অপেক্ষা করুন — প্রথমে CONFIG-এ আপনার SHEET_ID বসান এবং পেইজ রিফ্রেশ করুন।</td></tr>`
    } else {
      fetchData();
    }
  </script>
</body>
</html>
